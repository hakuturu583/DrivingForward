services:
  drivingforward:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      args:
        UID: "${UID:-1000}"
        GID: "${GID:-1000}"
    image: drivingforward:latest
    container_name: drivingforward
    user: "0:0"
    entrypoint: ["/workspace/DrivingForward/docker/entrypoint.sh"]
    volumes:
      - ..:/workspace/DrivingForward
      - ${NUSCENES_DATAROOT}:/workspace/DrivingForward/input_data/nuscenes
      - ../output:/workspace/DrivingForward/output
      - ../torchscript:/workspace/DrivingForward/torchscript
    working_dir: /workspace/DrivingForward
    environment:
      - UID=${UID:-1000}
      - GID=${GID:-1000}
      - DGP_PATH=/workspace/DrivingForward
      - XDG_CACHE_HOME=/workspace/DrivingForward/.cache
      - XDG_CONFIG_HOME=/workspace/DrivingForward/.config
      - MPLCONFIGDIR=/workspace/DrivingForward/.config/matplotlib
      - TORCH_CUDA_ARCH_LIST=7.5;8.0;8.6
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: ["gpu"]
    tty: true
    stdin_open: true
    shm_size: "24gb"
